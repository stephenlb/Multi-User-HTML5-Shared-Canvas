<html>
<head>
    <title>Shared Canvas</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
</head>
<body>
<style>
body, html, div {
    margin: 0;
    padding: 0;
}
canvas {
    width: 100vw;
    height: 100vh;
}

/* color canvas */
div#colors {
    display: flex;
    position: absolute;
    top: 20px;
    right: 20px;
    min-width: 300px;
    gap: 4px;
    height: 44px;
    box-shadow: 1px 1px 20px rgba(0,0,0,0.3);
    
    border: 2px solid rgba(255,255,255,0.1);
    background: rgba(255,255,255,0.1);
    padding: 8px;
    border-radius: 16px;

    backdrop-filter: blur(4px);
}

div#colors color {
    flex: 1;
    min-width: 40px;
    background-color: attr(hex type(<color>), red);
    border-radius: 8px;
    border: 2px solid rgba(255,255,255,0.2);

    transition: all 150ms cubic-bezier(.2,0,0,1);
}

div#colors color:active {
    scale: 1.4;
}
div#colors color.active {
    border: 2px solid white;
    box-shadow: 0 0 10px white;
    transform: scale(1.1);
}
</style>

<canvas id=canvas width=500 height=500></canvas>

<div id=colors>
    <color hex=#ff0000 class=active></color>
    <color hex=#00ff00></color>
    <color hex=#0000ff></color>
    <color hex=#ffff00></color>
    <color hex=#00ffff></color>
    <color hex=#ff00ff></color>
    <color hex=#4a412a></color>
</div>

<script src="pubnub.js"></script>
<script>
// TODO add pen icon
// TODO filter-expresion remove on userId
// TODO fix color per user
// TODO transmit curosor movent
// TODO context per remote user ( so each user can draw )
// TODO disable local drawing (maybe) or exclude self-draw
// TODO when creating  multiple context, even yourself is in the list
// TODO auto detect shape and draw perfect cirlc / box square
// TODO refactor so we can reuse 
// TODO on page resize update canvas vars so painting is accurate
// TODO add canvas load history
// TODO add number ONLINE USERS
// TODO draw line between last and current position
const userId     = `userId-${Math.random()}.${Math.random()}`;
const pubnub     = PubNub({});
const channel    = 'shared-canvas-v2';
const width      = 500;
const height     = 500;
const body       = document.querySelector('body');
const canvas     = document.getElementById('canvas');
const contexts   = {};
const context    = canvas.getContext('2d');

// Get user with context and x/y coords
getUser(userId);
function getUser(userId) {
    if (userId in contexts) return contexts[userId];
    contexts[userId] = {
        context : canvas.getContext('2d'),
        state: {
            userId  : userId,
            drawing : false,
            coords  : { x: 0, y: 0},
            style   : 'red',
        },
    };
    const user = contexts[userId];
    user.context.lineWidth = 5;
    user.context.strokeStyle = 'red';
    return user;
}

// Fill background with dark mode because Janlu
context.fillStyle = "#181818";
context.fillRect(0, 0, canvas.width, canvas.height);

// Draw line
function draw(userId) {
    const user    = getUser(userId);
    const context = user.context;
    const coords  = user.state.coords;
    const style   = user.state.style;

    // Start
    if (!user.state.drawing) {
        context.strokeStyle = style;
        context.beginPath();
        context.moveTo(coords.x, coords.y);
    }

    // Draw line
    if (user.state.drawing) {
        context.lineTo(coords.x, coords.y);
        context.stroke(); 
    }
}

function startCapture(event) {
    event.preventDefault();
    const user = getUser(userId);
    user.state.coords = getXY(event);
    user.state.drawing = true;
    broadcast(user.state);
}
function moveCapture(event) {
    event.preventDefault();
    const user = getUser(userId);
    user.state.coords = getXY(event);
    broadcast(user.state);
}
function endCapture(event) {
    event.preventDefault();
    const user = getUser(userId);
    user.state.coords = getXY(event);
    user.state.drawing = false;
    broadcast(user.state);
}

// Start
canvas.addEventListener( 'touchstart', startCapture);
canvas.addEventListener( 'mousedown', startCapture);

// End
canvas.addEventListener( 'mouseup', endCapture);
canvas.addEventListener( 'touchend', endCapture);

// Move
canvas.addEventListener( 'touchmove', moveCapture);
canvas.addEventListener( 'mousemove', moveCapture);

// Get Scaled Coordinates
function getXY(event) {
    const touch = event.changedTouches; 
    let x = 0;
    let y = 0;
    if (touch) {
        x = touch[0].clientX;
        y = touch[0].clientY;
    }
    else {
        x = event.offsetX;
        y = event.offsetY;
    }
    return {
        x: Math.floor((x / body.clientWidth) * width),
        y: Math.floor((y / body.clientHeight) * height),
    }
}

// Color Picker
const colors = document.getElementById('colors');
colors.addEventListener( 'click', (event) => {
    const user = getUser(userId);
    const target = event.target;
    const color = target.getAttribute('hex');
    if (!color) return;
    user.context.strokeStyle = color;
    user.state.style = color;
    document.querySelectorAll('#colors color').forEach(c => c.classList.remove('active'));
    target.classList.add('active');
});

pubnub.subscribe({
    channel: channel,
    messages: (state) => {
        const userId = state.userId;
        const user = getUser(userId);
        user.state = state;
        draw(userId);
    }
});

function broadcast(state) {
    pubnub.publish({
        channel: channel,
        message: state,
    });
}
</script>
</body>
</html>
